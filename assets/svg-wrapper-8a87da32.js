import{j as k}from"./chakra-594c63ee.js";import{t as T,N as ie,q as V,j as pe,d as X,af as K,ag as J,D as Y,ah as G,y as he,z as ce,S as be,e as Se,p as ae,v as U,r as de,E as le,A as ue,Q as we,K as ne,ai as re,J as Ee,a4 as Ne,a6 as ke}from"./index-4a8be9bb.js";import{r as ye,b as S}from"./react-2c0b8364.js";import{u as j,e as Ie,i as Le}from"./clipboard-3c5e2f79.js";import{b as B,r as M,F as Z,p as D,a as R}from"./helpers-ee1e194d.js";import{f as _e,a as Ce,b as Pe}from"./graph-6633e6b9.js";import{m as me}from"./misc-nodes-365f0184.js";import{s as Ae}from"./stations-5742aaef.js";const je=()=>{const[t,e]=ye.useState({width:void 0,height:void 0});return ye.useEffect(()=>{function n(){e({width:window.innerWidth,height:window.innerHeight})}return window.addEventListener("resize",n),n(),()=>window.removeEventListener("resize",n)},[]),t},fe=t=>t.filterNodes((e,n)=>e.startsWith("stn")).map(e=>[e,t.getNodeAttributes(e)]).filter(([e,n])=>n.visible).sort((e,n)=>e[1].zIndex-n[1].zIndex).map(([e,n])=>({node:e,visible:n.visible,zIndex:n.zIndex,x:n.x,y:n.y,type:n.type,[n.type]:n[n.type]})),ge=t=>t.filterDirectedEdges((e,n,c,r,g,A,u)=>e.startsWith("line")&&n.visible&&n.reconcileId==="").sort((e,n)=>t.getEdgeAttribute(e,"zIndex")-t.getEdgeAttribute(n,"zIndex")).map(e=>{const n=t.getEdgeAttribute(e,"type"),c=t.getEdgeAttribute(e,n),r=t.getEdgeAttribute(e,"style"),g=t.getEdgeAttribute(e,r),[A,u]=t.extremities(e),y=t.getNodeAttributes(A),x=t.getNodeAttributes(u);return{edge:e,x1:y.x,y1:y.y,x2:x.x,y2:x.y,type:n,attr:c,style:r,styleAttr:g}}),xe=t=>t.filterNodes((e,n)=>e.startsWith("misc_node")).map(e=>[e,t.getNodeAttributes(e)]).filter(([e,n])=>n.visible).sort((e,n)=>e[1].zIndex-n[1].zIndex).map(([e,n])=>({node:e,visible:n.visible,zIndex:n.zIndex,x:n.x,y:n.y,type:n.type,[n.type]:n[n.type]})),We=t=>{const e=t.filterDirectedEdges((c,r,g,A,u,y,x)=>c.startsWith("line")&&r.reconcileId!==""),n={};for(const c of e){const r=t.getEdgeAttribute(c,"reconcileId");r in n?n[r].push(c):n[r]=[c]}return n},ze=t=>{const e=We(t),n=[],c=[];return Object.values(e).forEach(r=>{var W;if(r.length===1){c.push(...r);return}const g=t.getEdgeAttribute(r.at(0),"type");if(!r.every(f=>t.getEdgeAttribute(f,"type")===g)){c.push(...r);return}const A=t.getEdgeAttribute(r.at(0),"style");if(!r.every(f=>t.getEdgeAttribute(f,"style")===A)){c.push(...r);return}const u={},y=new Set,x=new Set,E=Object.fromEntries(r.map(f=>{var $,O;const[I,P]=t.extremities(f);return u[I]=(($=u[I])!=null?$:0)+1,u[P]=((O=u[P])!=null?O:0)+1,y.add(I),x.add(P),[I,[f,P]]})),w=Array.from(y).filter(f=>u[f]===1),C=Array.from(x).filter(f=>u[f]===1);if(w.length!==1||C.length!==1){c.push(...r);return}const L=w[0],_=C[0];if(L===_){c.push(...r);return}const N=[E[L][0]];let p=E[L][1];for(let f=1;f<r.length;f=f+1){const I=(W=E[p])==null?void 0:W.at(1);if(!I){c.push(...r);return}N.push(E[p][0]),p=I}if(p!==_||N.length!==r.length){c.push(...r);return}n.push(N)}),{allReconciledLines:n,danglingLines:c}},De=(t,e)=>{if(!e.every(r=>t.hasEdge(r)))return;const n=e.map(r=>{var w;const[g,A]=t.extremities(r),u=t.getNodeAttributes(g),y=t.getNodeAttributes(A),x=t.getEdgeAttribute(r,"type"),E=(w=t.getEdgeAttribute(r,x))!=null?w:T[x].defaultAttrs;return T[x].generatePath(u.x,y.x,u.y,y.y,E)});let c=`${n[0]} `;for(let r=1;r<e.length;r=r+1)c+=n[r].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return c},oe=t=>{const{id:e,type:n,attrs:c=T[n].defaultAttrs,styleType:r,styleAttrs:g=ie[r].defaultAttrs,newLine:A,handleClick:u}=t,{x1:y,y1:x,x2:E,y2:w}=t,[C,L]=S.useState("M 0,0 L 0,0");S.useEffect(()=>{let N="M 0,0 L 0,0";if(["offsetFrom","offsetTo"].every(p=>Object.keys(c).includes(p))&&!Number.isNaN(c.offsetFrom)&&!Number.isNaN(c.offsetTo)&&c.offsetFrom===c.offsetTo&&((y===E||x===w)&&[V.Diagonal,V.Perpendicular].includes(n)||Math.abs((w-x)/(E-y))===1&&[V.Diagonal,V.RotatePerpendicular].includes(n))){const p=c.offsetFrom;N=T[V.Simple].generatePath(y,E,x,w,{offset:p})}else N=T[n].generatePath(y,E,x,w,c);L(N)},[n,JSON.stringify(c),y,E,x,w]);const _=ie[r].component;return S.useMemo(()=>k.jsx(_,{id:e,type:n,path:C,styleAttrs:g,newLine:A,handleClick:u}),[e,n,C,r,JSON.stringify(g),A,u])},Ke=()=>{const t=pe(),e=S.useRef(window.graph),{telemetry:{project:n}}=X(i=>i.app),{svgViewBoxZoom:c}=X(i=>i.param),{selected:r,refresh:{nodes:g,edges:A},mode:u,active:y,keepLastPath:x,theme:E}=X(i=>i.runtime),[w,C]=S.useState({x:0,y:0}),[L,_]=S.useState({x:0,y:0}),N=j((i,l)=>{l.stopPropagation(),u==="select"&&t(K("free"));const h=l.currentTarget,{x:v,y:s}=B(l);h.setPointerCapture(l.pointerId),C({x:v,y:s}),t(J(i)),!l.shiftKey&&r.length<=1&&t(Y()),t(G(i))}),p=j((i,l)=>{const{x:h,y:v}=B(l);u==="free"&&y===i?(r.forEach(s=>{e.current.updateNodeAttributes(s,o=>({...o,x:M(o.x-(w.x-h)*c/100,l.altKey?1:5),y:M(o.y-(w.y-v)*c/100,l.altKey?1:5)}))}),t(he()),t(ce())):u.startsWith("line")&&_({x:(w.x-h)*c/100,y:(w.y-v)*c/100})}),W=j((i,l)=>{if(u.startsWith("line")){x||t(K("free"));const h=[...Object.values(be),Se.Virtual],v=e.current.hasNode(y)&&h.includes(e.current.getNodeAttribute(y,"type"));["stn_core_","virtual_circle_"].forEach(o=>{var b,z;const m=(z=(b=document.elementsFromPoint(l.clientX,l.clientY)[0].attributes)==null?void 0:b.getNamedItem("id"))==null?void 0:z.value,d=m==null?void 0:m.startsWith(o);if(v&&d){const F=u.slice(5),ve=`line_${ae(10)}`;e.current.addDirectedEdgeWithKey(ve,y,m.slice(o.length),{visible:!0,zIndex:0,type:F,[F]:structuredClone(T[F].defaultAttrs),style:U.SingleColor,[U.SingleColor]:{color:E},reconcileId:""}),n&&de.event(le.ADD_LINE,{type:F})}}),t(ce()),t(ue(e.current.export()))}else if(u==="free")if(y){const{x:h,y:v}=B(l);w.x-h===0&&w.y-v===0?t(G(i)):t(ue(e.current.export()))}else t(G(i));t(J(void 0))}),f=j((i,l)=>{t(Y()),t(G(i))}),[I,P]=S.useState(fe(e.current)),[$,O]=S.useState(xe(e.current)),[q,H]=S.useState(ge(e.current)),[Q,ee]=S.useState([]),[te,se]=S.useState([]);return S.useEffect(()=>{P(fe(e.current)),O(xe(e.current))},[g]),S.useEffect(()=>{H(ge(e.current));const{allReconciledLines:i,danglingLines:l}=ze(e.current);ee(i),se(l)},[A]),k.jsxs(k.Fragment,{children:[te.map(i=>{const[l,h]=e.current.extremities(i),v=e.current.getNodeAttributes(l),s=e.current.getNodeAttributes(h);return k.jsx(oe,{id:i,x1:v.x,y1:v.y,x2:s.x,y2:s.y,newLine:!1,type:V.Simple,attrs:T[V.Simple].defaultAttrs,styleType:U.SingleColor,styleAttrs:{color:["","","#c0c0c0","#fff"]},handleClick:f},i)}),Q.map(i=>{const l=De(e.current,i);if(!l)return k.jsx(k.Fragment,{});const h=i.at(0),v=e.current.getEdgeAttribute(h,"type"),s=e.current.getEdgeAttribute(h,"style"),o=e.current.getEdgeAttribute(h,s),a=ie[s].component;return k.jsx(a,{id:h,type:v,path:l,styleAttrs:o,newLine:!1,handleClick:f},h)}),q.map(({edge:i,x1:l,y1:h,x2:v,y2:s,type:o,attr:a,style:m,styleAttr:d})=>k.jsx(oe,{id:i,x1:l,y1:h,x2:v,y2:s,newLine:!1,type:o,attrs:a,styleType:m,styleAttrs:d,handleClick:f},i)),$.map(i=>{const{node:l,x:h,y:v,type:s}=i,o=me[s].component;return k.jsx(o,{id:l,x:h,y:v,attrs:i[s],handlePointerDown:N,handlePointerMove:p,handlePointerUp:W},l)}),I.map(i=>{const{node:l,x:h,y:v,type:s}=i,o=Ae[s].component;return k.jsx(o,{id:l,x:h,y:v,attrs:{[s]:i[s]},handlePointerDown:N,handlePointerMove:p,handlePointerUp:W},l)}),u.startsWith("line")&&y&&k.jsx(oe,{id:"create_in_progress___no_use",x1:e.current.getNodeAttribute(y,"x"),y1:e.current.getNodeAttribute(y,"y"),x2:e.current.getNodeAttribute(y,"x")-L.x,y2:e.current.getNodeAttribute(y,"y")-L.y,newLine:!0,type:u.slice(5),attrs:T[u.slice(5)].defaultAttrs,styleType:U.SingleColor,styleAttrs:{color:E}})]})},Ye=()=>{var h,v;const t=pe(),e=S.useRef(window.graph),n=()=>{t(he()),t(ce()),t(ue(e.current.export()))},{telemetry:{project:c}}=X(s=>s.app),{svgViewBoxZoom:r,svgViewBoxMin:g}=X(s=>s.param),{mode:A,lastTool:u,active:y,selected:x,keepLastPath:E,theme:w,refresh:{nodes:C}}=X(s=>s.runtime),L=je(),_=((h=L.height)!=null?h:1280)-40,N=((v=L.width)!=null?v:720)-40;S.useEffect(()=>{const s=_e(e.current);Object.entries(s).filter(([o,a])=>a&&o in Z).map(([o,a])=>o).filter(o=>Z[o]&&document.getElementById(Z[o].cssName)===null).map(o=>Z[o].cssName).filter((o,a,m)=>a===m.findIndex(d=>d===o)).forEach(o=>{const a=document.createElement("link");a.rel="stylesheet",a.id=o,a.href=`/rmp/styles/${o}.css`,document.head.append(a)})},[C]);const[p,W]=S.useState({x:0,y:0}),[f,I]=S.useState({x:0,y:0}),[P,$]=S.useState({x:0,y:0}),[O,q]=S.useState({x:0,y:0}),H=j(s=>{const{x:o,y:a}=B(s);if(A.startsWith("station")){t(K("free"));const m=ae(10),d=A.slice(8),b=structuredClone(Ae[d].defaultAttrs);"color"in b&&(b.color=w);const{x:z,y:F}=D(o,a,r,g);e.current.addNode(`stn_${m}`,{visible:!0,zIndex:0,x:M(z,5),y:M(F,5),type:d,[d]:b}),n(),c&&de.event(le.ADD_STATION,{type:d})}else if(A.startsWith("misc-node")){t(K("free"));const m=ae(10),d=A.slice(10),{x:b,y:z}=D(o,a,r,g);e.current.addNode(`misc_node_${m}`,{visible:!0,zIndex:0,x:M(b,5),y:M(z,5),type:d,[d]:structuredClone(me[d].defaultAttrs)}),n(),c&&de.event(le.ADD_STATION,{type:d})}else A==="free"||A.startsWith("line")?(A.startsWith("line")&&(t(K("free")),E&&t(we(!1))),$({x:o,y:a}),q(g),s.shiftKey||(t(J("background")),t(Y()))):A==="select"&&(W(D(o,a,r,g)),I(D(o,a,r,g)))}),Q=j(s=>{if(A==="select"){if(p.x!=0&&p.y!=0){const{x:o,y:a}=B(s);I(D(o,a,r,g))}}else if(y==="background"){const{x:o,y:a}=B(s);t(ne({x:O.x+(P.x-o)*r/100,y:O.y+(P.y-a)*r/100}))}}),ee=j(s=>{if(A==="select"){const{x:o,y:a}=B(s),{x:m,y:d}=D(o,a,r,g),b=Ce(e.current,p.x,p.y,m,d);s.shiftKey?t(re([...new Set([...x,...b])])):t(re(b)),t(K("free")),W({x:0,y:0}),I({x:0,y:0})}y==="background"&&!s.shiftKey&&t(J(void 0))}),te=j(s=>{let o=r;s.deltaY>0&&r+10<400?o=r+10:s.deltaY<0&&r-10>0&&(o=r-10),t(Ee(o));const{x:a,y:m}=B(s),d=s.currentTarget.getBoundingClientRect(),[b,z]=[a/d.width,m/d.height];t(ne({x:g.x+a*r/100-N*o/100*b,y:g.y+m*r/100-_*o/100*z}))}),se=j(async s=>{if(R?s.key==="Backspace":s.key==="Delete")x.length>0&&x.filter(o=>e.current.hasNode(o)||e.current.hasEdge(o)).forEach(o=>{t(Y()),e.current.hasNode(o)?e.current.dropNode(o):e.current.dropEdge(o),n()});else if(s.key.startsWith("Arrow")){const a=s.key.endsWith("Left")?-1:s.key.endsWith("Right")?1:0,m=s.key.endsWith("Up")?-1:s.key.endsWith("Down")?1:0;t(ne(D(100*a,100*m,r,g)))}else if(s.key==="i"||s.key==="j"||s.key==="k"||s.key==="l"){const a=(s.key==="j"?-1:s.key==="l"?1:0)*10,m=(s.key==="i"?-1:s.key==="k"?1:0)*10;x.length>0&&x.filter(d=>e.current.hasNode(d)).forEach(d=>{e.current.updateNodeAttribute(d,"x",b=>(b!=null?b:0)+a),e.current.updateNodeAttribute(d,"y",b=>(b!=null?b:0)+m),n()})}else if(s.key==="f"&&u)t(K(u));else if(s.key==="z"&&(R?s.metaKey&&!s.shiftKey:s.ctrlKey))R&&s.preventDefault(),t(Ne());else if(s.key==="s")t(K("select"));else if((s.key==="c"||s.key==="x")&&(R?s.metaKey&&!s.shiftKey:s.ctrlKey)){const o=new Set(x),a=Pe(e.current,o),m=Ie(e.current,o,new Set(a));navigator.clipboard.writeText(m),s.key==="x"&&(t(Y()),x.forEach(d=>{e.current.hasNode(d)?e.current.dropNode(d):e.current.hasEdge(d)&&e.current.dropEdge(d)}),n())}else if(s.key==="v"&&(R?s.metaKey&&!s.shiftKey:s.ctrlKey)){const o=await navigator.clipboard.readText(),{x:a,y:m}=D(N/2,_/2,r,g),{nodes:d}=Le(o,e.current,M(a,5),M(m,5));n(),t(Y()),t(re(d))}else(R&&s.key==="z"&&s.metaKey&&s.shiftKey||!R&&s.key==="y"&&s.ctrlKey)&&t(ke())}),[i,l]=S.useState({sx:0,sy:0,ex:0,ey:0});return S.useEffect(()=>{l({sx:p.x<=f.x?p.x:f.x,ex:p.x>f.x?p.x:f.x,sy:p.y<=f.y?p.y:f.y,ey:p.y>f.y?p.y:f.y})},[f.x,f.y]),k.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:40,userSelect:"none"},height:_,width:N,viewBox:`${g.x} ${g.y} ${N*r/100} ${_*r/100}`,onPointerDown:H,onPointerMove:Q,onPointerUp:ee,onWheel:te,tabIndex:0,onKeyDown:se,children:[k.jsx(Ke,{}),A==="select"&&p.x!=0&&p.y!=0&&k.jsx("rect",{x:i.sx,y:i.sy,width:i.ex-i.sx,height:i.ey-i.sy,rx:"2",stroke:"#b5b5b6",strokeWidth:"2",strokeOpacity:"0.4",fill:"#b5b5b6",opacity:"0.75"})]})};export{Ye as default};
